name: Production Deploy - ç¾å ´å®‰å…¨æ€§ç¢ºä¿

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
  production-safety-check:
    runs-on: ubuntu-latest
    name: æœ¬ç•ªå®‰å…¨æ€§æœ€çµ‚ãƒã‚§ãƒƒã‚¯
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Critical functionality test (æœ€é‡è¦æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ)
      run: |
        echo "ğŸš¨ ç¾å ´ã§çµ¶å¯¾ã«å£Šã‚Œã¦ã»ã—ããªã„éƒ¨åˆ†ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        npm run test:critical
        
    - name: Full test suite (å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ)
      run: npm run test:coverage
      
    - name: Type safety check (å‹å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯)
      run: npm run type-check
      
    - name: Code quality check (ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯)
      run: npm run lint
      
    - name: Build verification (ãƒ“ãƒ«ãƒ‰æ¤œè¨¼)
      run: npm run build
      
    - name: Production ready notification
      run: |
        echo "âœ… æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†ï¼"
        echo "ç¾å ´ã§å£Šã‚Œã¦å›°ã‚‹éƒ¨åˆ†ã¯å…¨ã¦å®ˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚"
        echo "ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¾ã™..."

  # Vercel ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-vercel:
    runs-on: ubuntu-latest
    needs: production-safety-check
    if: success()
    name: Vercelæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
        
    - name: Deploy success notification
      run: |
        echo "ğŸ‰ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸï¼"
        echo "ç¾å ´ã§å®‰å¿ƒã—ã¦ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚"

  # Netlify ãƒ‡ãƒ—ãƒ­ã‚¤ (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)
  deploy-netlify:
    runs-on: ubuntu-latest
    needs: production-safety-check
    if: success()
    name: Netlifyæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build for Netlify
      run: npm run build
      
    - name: Deploy to Netlify
      uses: nwtgck/actions-netlify@v2.0
      with:
        publish-dir: './dist'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "Deploy from GitHub Actions"
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã®ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆ
  emergency-alert:
    runs-on: ubuntu-latest
    needs: [deploy-vercel, deploy-netlify]
    if: failure()
    name: ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥
    
    steps:
    - name: Emergency notification
      run: |
        echo "ğŸš¨ğŸš¨ğŸš¨ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸï¼ğŸš¨ğŸš¨ğŸš¨"
        echo "ç¾å ´ã§ã®åˆ©ç”¨ã«å½±éŸ¿ãŒå‡ºã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
        echo "å³åº§ã«ç¢ºèªãƒ»ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚"
        # Slacké€šçŸ¥ä¾‹
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ğŸš¨ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ï¼ç¾å ´ç¢ºèªãŒå¿…è¦ã§ã™ã€‚"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }} 
        