name: CI/CD Pipeline - ç¾å ´å®‰å…¨æ€§ç¢ºä¿

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ç¾å ´ã§å£Šã‚Œã¦å›°ã‚‹éƒ¨åˆ†ã®ãƒ†ã‚¹ãƒˆãƒ»å‹ãƒ»ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
  safety-check:
    runs-on: ubuntu-latest
    name: ç¾å ´å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Type check (å‹å®‰å…¨æ€§ç¢ºä¿)
      run: npm run type-check
      
    - name: Lint check (ã‚³ãƒ¼ãƒ‰å“è³ªç¢ºä¿)
      run: npm run lint
      
    - name: Run tests (ç¾å ´ã§å£Šã‚Œã¦å›°ã‚‹éƒ¨åˆ†ã®ãƒ†ã‚¹ãƒˆ)
      run: npm run test:coverage
      
    - name: Build check (ãƒ“ãƒ«ãƒ‰æˆåŠŸç¢ºèª)
      run: npm run build
      
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # ç¾å ´é‹ç”¨ã®ãŸã‚ã®é€šçŸ¥ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: safety-check
    if: failure()
    name: ç¾å ´ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥
    
    steps:
    - name: Notify failure (Slack/Teamsç­‰)
      run: |
        echo "ğŸš¨ ç¾å ´ã§å£Šã‚Œã¦å›°ã‚‹éƒ¨åˆ†ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸï¼"
        echo "å³åº§ã«ç¢ºèªãƒ»ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚"
        # ã“ã“ã«Slack/Teamsé€šçŸ¥ã®è¨­å®šã‚’è¿½åŠ å¯èƒ½
        # ä¾‹: curl -X POST -H 'Content-type: application/json' --data '{"text":"ğŸš¨ ã‚±ã‚¢è¨˜éŒ²ã‚¢ãƒ—ãƒªã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸï¼"}' $SLACK_WEBHOOK_URL

  # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯
  pre-deploy-check:
    runs-on: ubuntu-latest
    needs: safety-check
    if: success()
    name: ãƒ‡ãƒ—ãƒ­ã‚¤å‰æœ€çµ‚ãƒã‚§ãƒƒã‚¯
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Critical tests (æœ€é‡è¦ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ)
      run: |
        # ç¾å ´ã§çµ¶å¯¾ã«å£Šã‚Œã¦ã»ã—ããªã„éƒ¨åˆ†ã®ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
        npx vitest run tests/UsersPage.test.tsx
        npx vitest run tests/DailyLogInputPage.test.tsx
        npx vitest run tests/StaffPage.test.tsx
        npx vitest run tests/ReportsPage.test.tsx
      
    - name: Deploy ready notification
      run: |
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†ï¼ç¾å ´ã§å£Šã‚Œã¦å›°ã‚‹éƒ¨åˆ†ã¯å…¨ã¦å®ˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚" 
# kick: no-op line for PR diff
