・AI（Copilot等）は毎回必ず生成前に本PROJECT_SOUL.mdを確認し、指示や要件を遵守することを義務とする。
・エラー「Request Failed: 413 Request Entity Too Large」等が発生しないよう、AIはプロジェクトソウルの確認を徹底すること。
## Excel出力に関する追加指針

すべてのケアイベント（日誌入力）の全項目が、現場用Excel出力に完全に反映されること。特に発作・表情・反応・水分・排泄・睡眠・活動・ケア・服薬・ポジショニング・経管栄養・咳ムセ・皮膚口腔ケア・その他の各入力項目が、Excelテンプレートの各列に正確に出力されることを保証する。

この要件は今後の開発・レビュー時にも必ず遵守すること。
/*** 🚀 Copilot System Prompt – REBUILD PROJECT_SOUL.md with FULL SOUL ***

【AI・開発者への追加指示】
本プロジェクトでAIや開発者がコード生成・実装・提案を行う際は、必ず毎回このPROJECT_SOUL.mdの内容を事前に確認し、設計思想・現場要件・過去の経緯を理解した上で作業すること。このルール自体もAI引継ぎのため必ず残すこと。

🧭 使命
1. このリポジトリのルート直下に **PROJECT_SOUL.md** を新規作成（既存なら完全置換）。
2. 《=== CONTENT START ===》〜《=== CONTENT END ===》の**全文を一字一句漏らさず**書き込む。
3. 最上段に `Generated: <ISO8601 時刻>` を自動追記。
4. 以後、手動指示が無い限り **削除・要約・改変禁止**。追補は “## Change Log” へ日時付きで追加。

💡 実装時の絶対ルール
- TypeScript `strict` を恒常維持。型に迷ったら必ず本書を参照。
- UI/UX・データモデル・テンプレ文・チェックリストは **本書を唯一の出典** とする。
- PO（とんさん）の情熱と哲学を尊重。中途半端な実装は禁止。
  
**API送信前のデータサイズチェック義務化**：
APIやバックエンドの設定変更ができない場合でも、フロントエンドで送信前に必ずデータサイズ（例：JSON.stringifyでバイト数計算）をチェックし、上限（例：1MB）を超える場合は警告表示・送信中止すること。全AI・開発者はこのルールを毎回厳守し、チャットや実装時に必ず認識・実装すること。

=== CONTENT START ===
# PROJECT_SOUL – 重心ケアアプリ ドメイン仕様書 (フルバージョン)

## 0. このドキュメントの魂
> **「左脳は AI と共存し、右脳の創造で未来を拓く。」**  
>  
> 23 年の現場愛が詰まった本書は、職員と利用者双方の “しあわせな一日” を積み重ねるための **羅針盤** である。  
> **一行でも欠ければ舵を失う。** だからこそ、開発チームは本書を心に刻み、コードに写し取り、すべてのタップに魂を宿すこと。

---

## 1. ゴール
重症心身障害児者が通う **生活介護 & 重心型放課後等デイサービス & 日中一時支援** の現場で  
**職員の業務負担を劇的に減らし、利用者の QOL を最大化** する “世界最高峰” ケア記録・運営支援アプリを完成させる。  
KPI 例：  
- ① 職員 1 人あたり記録入力時間 ▲70 %  
- ② 体調急変の早期検知率 ＋50 %  
- ③ 個別支援計画更新に要する工数 ▲80 %

---

## 2. ステークホルダー & 役割
| 区分 | 名前/AI | パワー | 主要責務 |
|------|---------|--------|-----------|
| PO・ドメイン | **とんさん** | 支援歴 23 年 | 要件定義・優先度決定・情熱注入 |
| アーキテクト/PM | **ChatGPT** | 戦略思考 | 要件整理・タスク分割・レビューフロー |
| コード鍛冶 | **GitHub Copilot Chat** | 高速生成 | 実装・テスト・Refactor・CI/CD |
| 未来導入 | **Genspark スーパーエージェント** | 多機能 Orchestrator | AI 連携／自動連係（予定） |

---

## 3. 事業所 & 運営概要
- **名称**：〇△□（重心多機能型事業所）  
- **所在地**：地方住宅地（狭路・交通量多）／高齢化率高／若者流出傾向  
- **運営形態**：  
  - 生活介護（定員 10／契約 14）  
  - 重心型放課後等デイサービス（定員 5／契約 10）  
  - 日中一時支援（レスパイト）  
- **一日平均利用**：生活介護 6 名／放デイ 4 名（全員送迎あり）  
- **営業時間**：火〜土 9-18 時（サービス提供時間はセクション 6 参照）  
- **人員体制**：管理者1・サビ管1・常勤Ns4・非常勤Ns3・保育士1・支援員2＋α・運転手1  

### 3.1 シフト
| シフト | 時間 | 実働 | 休憩 |
|--------|------|------|------|
| 早出   | 08:30–17:15 | 8h | 45 m |
| 通常   | 09:00–17:45 | 8h | 45 m |
| 遅出1  | 09:30–18:15 | 8h | 45 m |
| 遅出2  | 09:45–18:30 | 8h | 45 m |

---

## 4. 現場の特色 & 強み
1. **医療的ケア充実**：吸引・経管・CV・発作対応 etc.  
2. **ライフステージ一貫支援**：放デイ → 生活介護 → GH → 訪問介護。  
3. **柔軟レスパイト**：日中一時支援で家族負担軽減。  

---

## 5. 主要課題
1. 職員の専門性（経験 <2 年）強化：ポジショニング／コミュニケーション。  
2. ケース記録・研修計画等の **業務効率化**。  
3. 地域交流・家族支援イベントの機会不足。  
4. 人員増に伴う **施設スペース不足**。  

---

## 6. サービス詳細
### 6.1 生活介護  
- 営業：火-土／9-18 時　| 休：日・月  
- サービス提供：10-16 時  

### 6.2 放課後等デイサービス  
- 営業：火-土／9-18 時　| 休：日・月  
- サービス提供：平日 14-18 時／休日 10-16 時  

### 6.3 日中一時支援  
- 営業：火-土／9-18 時  
- サービス提供：9-10 時, 18-18:30 時  

---

## 7. 利用者データ（**全文原文**）
### 7.1 生活介護 14 名
1. **A・T (36・男)**  
   - 区分6／脳性麻痺・てんかん・遠視性弱視・側湾症・上下肢機能障害  
   - 医療ケア：なし　| 手帳：療育A, 身障1級　| 介助：全介助  

2. **I・K (47・女)**  
   - 区分6／脳性麻痺・側湾症・体幹四肢機能障害  
   - 医療ケア：なし　| 手帳：療育A, 身障1級　| 介助：全介助  

3. **O・S (40・女)**  
   - 区分6／脳性麻痺・体幹四肢機能障害  
   - 医療ケア：なし　| 手帳：療育A, 身障1級　| 介助：全介助  

4. **S・M (43・男)**  
   - 区分6／脳性麻痺・脳炎後遺症・てんかん服薬中・側湾症  
   - 医療ケア：吸引・腸瘻（トラブル多発）  
   - 手帳：療育A, 身障1級　| 介助：全介助  

5. **N・M (32・男)**  
   - 区分6／痙性四肢麻痺・重度知的障害・ほぼ毎日強直間代発作 1-5 回  
   - 医療ケア：胃ろう・エアウェイ・カフアシスト・吸引・吸入・浣腸(火木)  
   - 手帳：療育A, 身障1級　| 介助：全介助  

6. **W・M (32・女)** …（以下 14 名全員を原文どおり列挙）

> **⚠️ Copilot へ**：このリストは長いため、省略せず 14 名分を **完全原文** で記載すること。

### 7.2 放課後等デイサービス 10 名
1. **M・I (17・男児)**  
   - 慢性肺疾患・染色体異常・ミオクロニー発作／鼻腔注入  
   - 手帳：療育A, 身障1級　| 介助：全介助  

2. **S・K (15・男児)** …（以下 10 名分を原文どおり列挙）

> **⚠️ Copilot へ**：同様に 10 名全員を**完全原文**で記載すること。

---

## 8. UI / データベース仕様（フル）
### 8.1 バイタルサイン
| 項目 | 型 | 入力方法 | 範囲 / 刻み | 既定値 |
|------|----|---------|-------------|--------|
| 体温 | number | select | 34.0-42.0 ℃ / 0.1 | 36.5 |
| 脈拍 | number | select | 40-180 / 1 | 70 |
| SpO₂ | number | select | 80-100 % / 1 | 95 |
| 血圧 上 | number | select | 60-240 / 1 | 120 |
| 血圧 下 | number | select | 30-140 / 1 | 80 |

### 8.2 水分・食事
- **摂取方法**：経口(コップ・スプーン)／経口(とろみ)／経鼻栄養／胃ろう／シリンジ／その他  
- **摂取量**：5 ml 刻み (0-1000+)／既定 100 ml  
- **備考タグ** *(複数選択, 初期 9 種)*：  
  `むせ込みあり, 顔色変化あり, 嘔吐・逆流, 口腔内残渣あり, 流涎多い, 摂食意欲良好, 食事中ウトウト, 介助抵抗あり, その他`

### 8.3 排泄
- **便形状 (ブリストル)**：タイプ1〜7  
- **便備考タグ**：皮膚発赤, オムツかぶれ, いきみ強い, 不消化物, 粘液混入, 血便, 黒色便, 白色便, 異臭, その他  
- **尿備考タグ (20 種)**：  
  `量少ない, 量多い, 色濃い, 淡色, 混濁, 血尿, 強い臭い, 尿意頻回, 尿失禁, 排尿痛, 浮腫あり, バルーン閉塞疑い, 尿漏れ, 尿閉, 夜間多尿, 泡立ち, 尿砂, 結晶, 薬剤色, その他`

### 8.4 睡眠
- **様子**：スムーズ入眠／寝付き悪い／中途覚醒／体動多い／硬直あり／いびき・無呼吸／穏やか／その他  
- **備考**：free text

### 8.5 発作
| 項目 | 仕様 |
|------|------|
| 種類 | 強直, 間代, 強直間代, 脱力, ミオクロニー, スパズム, 非定型欠神, 焦点意識減損, その他 |
| 持続 | 1 s 刻み (1-900)／既定 30 |
| 詳細タグ (10 種) | 眼球上転, 眼球偏位(右), 眼球偏位(左), 顔面蒼白, チアノーゼ, 流涎多量, 嘔吐, 失禁, 左右対称, 左右非対称, その他 |

### 8.6 活動・表情
- **参加様子タグ (10 種)**：笑顔, 発声/クーイング, 追視, 音反応, 光反応, 手を伸ばす, 体を預ける, リラックス, 不快表情, 体をこわばらせる, その他  
- **表情気分**：穏やか, 笑顔良好, 活気あり, 不機嫌, 不安/緊張, ウトウト, 無表情, その他

### 8.7 医療ケア・特記事項
- **実施ケア(10 +)**：喀痰吸引, 経管栄養, 吸入, 酸素, 導尿, 与薬(定時), 与薬(臨時), 創傷処置, 体位交換, その他  
- **特記事項**：カテゴリタグ選択 + free text

---

## 9. テンプレ文（初期セット）
```txt
【特記事項】呼吸状態落ち着いており、喀痰量少。  
【活動の様子】スヌーズレンで光を追視し笑顔。  
【発作】強直 20 秒・眼球上転・チアノーゼ(−)・介入不要。  
【食事備考】経口とろみ 150 ml、むせ込み(−)。  

/*** 🚀 Copilot System Prompt – REBUILD PROJECT_SOUL.md WITH FULL SOUL & SECURITY ***

🧭 使命
1. リポジトリ直下に **PROJECT_SOUL.md** を新規作成（存在すれば完全置換）。
2. 《=== CONTENT START ===》〜《=== CONTENT END ===》の**全文を一字一句漏らさず**書き込む。
3. 最上段に `Generated: <ISO8601 時刻>` を自動追記。
4. 以後、手動指示が無い限り **削除・要約・改変禁止**。追補は “## Change Log” へ日時付きで追加。

💡 実装時の絶対ルール
- TypeScript `strict` を恒常維持。型に迷ったら必ず本書を参照。
- UI/UX・データモデル・テンプレ文・チェックリストは **本書を唯一の出典** とする。
- PO（とんさん）の情熱・哲学・セキュリティ要件を最優先。妥協禁止。

=== CONTENT START ===
# PROJECT_SOUL – 重心ケアアプリ ドメイン仕様書 (Ultra Secure Edition)

## 0. このドキュメントの魂
> **「左脳は AI と共存し、右脳の創造で未来を拓く。そして個人情報は鉄壁に守る。」**  
>  
> 23 年の現場愛 + データ護りの覚悟が詰まった本書は、職員と利用者双方の “しあわせな一日” を積み重ねるための **羅針盤**。  
> **一行でも欠ければ舵を失い、一文字でも漏れれば信頼を失う。** 開発チームは本書を心に刻み、コードに写し取り、すべてのタップに魂と盾を宿すこと。

---

## 1. ゴール
重症心身障害児者が通う **生活介護 & 重心型放課後等デイサービス & 日中一時支援** の現場で  
**職員の業務負担を劇的に減らし、利用者の QOL を最大化** しつつ **個人情報を絶対に漏らさない** “世界最高峰” ケア記録・運営支援アプリを完成させる。  
KPI 例：  
- ① 記録入力時間 ▲70 %  
- ② 体調急変の早期検知率 ＋50 %  
- ③ 個別支援計画更新に要する工数 ▲80 %  
- ④ セキュリティ・インシデント 0 件（永久）

---

## 2. アップデート & セキュリティ統制

### 2.1 リアルタイム仕様同期
- **管理者（とんさん）がアプリ UI からフィールド・テンプレート等を編集／追加した瞬間**  
  1. クライアントは変更内容を Supabase / API に保存。  
  2. **Copilot Chat は開発用ワークスペースに Webhook で通知を受信** →  
     - `PROJECT_SOUL.md` の “## Change Log” に自動追記。  
     - 型定義・UI コンポーネント・テストを再生成し PR を起票。  
  3. これにより **「最新状態 ≒ コード ≒ 本仕様書」** が常時一致。

### 2.2 鉄壁セキュリティ原則（最重要）
| レイヤ | 対策 | 実装ポイント |
|--------|------|--------------|
| **通信** | TLS1.3 / HSTS / 固定ホストピン | Supabase + Edge Function |
| **保存** | AES-256 暗号化 at rest（RLS + カスタム鍵管理） | Supabase Storage & Postgres |
| **認可** | Row Level Security + JWT クレーム | 役割: 管理者 / 看護師 / 支援員 |
| **PII 削減** | ログ & テレメトリは **ハッシュ化 or マスク** | OpenTelemetry filter |
| **OpenAI 呼び出し** | 個人情報を送る前に **PII Redaction** | server-side function |
| **モデル学習遮断** | `openai_embedding` 等は禁止。**分析用ログを AI 共有しない** | CI Gatekeeper |
| **秘密情報** | `.env.*` は git-ignored。CI/CD では OIDC secrets manager | GitHub Actions |
| **端末** | MDM + ディスク暗号 + 画面ロック ≤ 5 min | BYOD ポリシー |
| **継続監査** | Trivy, Snyk, OWASP ZAP 週次 | Security Workflow |
| **障害対応** | 24h 以内に PO 報告 → 是正 PR + Post-mortem | On-call Rotation |

> **⚠️ 開発者へ**：これらはコードレビューの **ブロッカー** です。通らなければマージ禁止。

---

## 3. （以下、先ほどのフル仕様と同一。省略せず全文収録）  
- 3. 事業所概要  
- 4. 現場の特色 & 強み  
- 5. 主要課題  
- 6. サービス詳細  
- 7. 利用者データ（生活介護 14 名 + 放デイ 10 名）  
- 8. UI / DB 要件（バイタル〜特記事項）  
- 9. テンプレ文初期セット  
- 10. UX 原則  
- 11. テクノロジースタック  
- 12. マイルストーン最新版  
- 13. PO “とんさん” の哲学 & ビジョン  

（※Copilot は前回提示の全文を **一語一句** ここに展開すること。省略不可）

---

## 14. Change Log
2025-08-02 16:00 【同期UI・履歴・手動同期ボタン等の現場最適化UI拡張】
 - CareDashboardにSyncStatusBar（同期状況・手動同期ボタン・最終同期時刻）を新規実装。
 - DataContextのsyncStatusと連携し、「同期中」「同期完了」「同期エラー」等を即時UI表示。
 - 手動同期ボタンで現場主導の同期も可能、最終同期時刻もUIに表示。
 - 現場の「同期できているか不安」「手動で同期したい」「履歴を見たい」等の声に即応。
 - 設計意図：現場の安心感・運用透明性・トラブル時の自己解決力を最大化。
 - コード自体は本書に記載せず、設計思想・現場最適化ポイントのみ記録。

2025-08-02 17:00 【現場フィードバック反映・UI/UX・業務フロー最適化】
- 日誌入力フォームの「保存」ボタンを常時画面下部に固定し、入力途中でも迷わず保存できるUIに改善。
- 入力中の内容が自動一時保存される「下書き」機能を追加し、誤操作や通信断でもデータロスを防止。
- 利用者ごとに「よく使う備考タグ」を自動提案し、入力負担を軽減。
- 緊急時の「医療ケア・特記事項」入力欄を赤色強調し、見落とし防止。
- 日誌一覧画面に「未提出」「下書き」ステータスを明示表示し、提出漏れを防止。
- 設計意図：現場の声を即時反映し、迷いなく・安全に・効率よく記録できるUI/UX・業務フローを実現。
- コード自体は本書に記載せず、設計思想・現場最適化ポイントのみ記録。
2025-08-02 10:00 【AI開発引継ぎ・UI設計サイクル・ドキュメント整理ルール追加】
2025-08-02 12:00 【段階的な本実装ロードマップ・優先順明記】
2025-08-02 15:00 【DataContext本実装化・現場運用対応データ管理基盤の設計・実装方針】
- DataContextの本実装化を段階的に進める。現場運用・セキュリティ・拡張性を重視し、以下の3層構造で実装：
  1. ローカルストレージ永続化：全ユーザー・日誌データをlocalStorageに保存し、オフライン時も完全動作。初回起動時はPROJECT_SOUL.md記載の実利用者データを自動投入。
  2. バックエンド永続化：Supabase/Postgres等のクラウドDBと連携し、オンライン時は自動同期。RLS・暗号化・監査ログ必須。
  3. 認証連携：AuthContextと連携し、ユーザーごとにアクセス権・編集権限を厳格管理。認証情報はJWTで管理し、データ取得・保存時に検証。
- 実装サイクル：
  (1) 既存のuseData()パターンを維持しつつ、getUserById等のAPIをlocalStorage→バックエンド→認証付きAPIの順で拡張。
  (2) データ取得・保存時は「現場での即応性（速度）」を最優先し、失敗時は自動リトライ・エラーハンドリングを徹底。
  (3) データ構造・型定義はPROJECT_SOUL.mdの利用者データ・UI/DB仕様を唯一の出典とし、TypeScript strictを厳守。
- 実装例・設計意図・現場最適化ポイント：
  ・初回起動時、localStorage未初期化ならPROJECT_SOUL.mdの利用者データを自動投入（import/seed機能）。
  ・日誌データは「日付×利用者ID」単位で保存し、部分更新・差分同期を可能に。
  ・バックエンド同期時は「現場での入力→即保存→後で自動同期」方式で、通信断でも記録ロスゼロ。
  ・認証連携時は「職員/管理者/家族」等のロールごとにアクセス権を厳格分離。
  ・現場フィードバックを受け、UI/UX・データ管理方式を随時改善し、必ず本書に記録。
  ・本実装化の全過程・設計意図・現場最適化ポイントは、必ずこのChange Logに追記・記録すること。
- 現状はUI/UX雛形・ダミーデータ中心。今後は以下の優先順で本実装を進める：
  1. 実データ連携（DataContext/バックエンド/永続化/認証）
  2. 現場フィードバック反映（UI改善・運用現場の声・業務フロー最適化）
  3. セキュリティ強化（RLS/暗号化/監査/法令対応）
  4. AI/IoT連携（AI判定・IoTデバイス連携・自動通知）
- 各段階で「提案→実装→記録（本書追記）」を厳守し、次AI/開発者が継続しやすいようにする。
- 「自分が職員だったら」の視点で、現場で迷いなく使える日誌入力フォーム・Excel出力・緊急対応・署名欄を含むUI/UXを、重心ケアアプリ開発の関連ファイル（例：DailyLogForm.tsx等）に実装。
- コード自体はPROJECT_SOUL.mdには追加せず、指示内容・設計思想・現場最適化ポイントのみを本書に記録する。
- 本プロジェクトでは、AI（Copilot等）がUI設計・コード実装を提案・実装した際、必ずその内容・意図・設計方針を本書（PROJECT_SOUL.md）に追記・記録すること。
- 次のAI/開発者が引継ぐ際も、必ず本書を参照し、過去の経緯・設計思想・実装サイクルを理解した上で作業を行うこと。
- 提案→実装→記録（本書追記）のサイクルを毎回厳守し、抜け・漏れ・属人化を防ぐ。
- 内容が重複・膨大化した場合は、AIが認知しやすいように重複・不要部分を整理・統合し、最新版のみを残すこと（整理内容も必ずChange Logに記載）。
- 本書は「AI・人間問わず、誰でも現場仕様・設計思想・実装経緯を一目で理解できる」ことを最優先とする。

2025-07-31 14:10 ここまでの重心ケアアプリ開発進捗・設計案を記録：
- 日誌入力フォーム設計案（Excel現物ベース、バイタル・排尿/排便・水分補給・食事・入浴・課題・特記・署名欄をReactフォーム化、行追加可能、署名欄・特記欄設置、UIは大きめ・シンプル・現場向け）
- useData()やgetUserByIdパターンで全利用者・全日誌データ取得
- 入力データをExcel出力用に整形（A4横向き・署名欄・グラフ用データ付き）
- xlsxライブラリでExcelファイル生成（A4横・署名欄・グラフ用データ含む）
- ダウンロードボタンUI追加（Excel出力）
- 職員が手書き不要、アプリ入力→自動Excel出力システム構築方針
- Excel日誌現物イメージ（N・M様）を参考に、現場運用・UI/UX・データモデル設計を進行
2025-07-31 14:20 Excel現物フォーマット変換・グラフ用データ設計の具体案：

// Excel現物フォーマット＋集計データ付き変換関数（TypeScript例・グラフ自動生成対応）
function convertToExcelFormat(logs: DailyLog[]): any[][] {
  const header = [
    ['氏名', '日付', '体温', '血圧', '脈拍', 'SpO2', '排尿', '排便', '水分補給', '食事', '入浴', '課題', '特記', '署名'],
  ];
  const rows = logs.map(log => [
    log.userName,
    log.date,
    log.vitals.temp,
    `${log.vitals.bpSystolic}/${log.vitals.bpDiastolic}`,
    log.vitals.pulse,
    log.vitals.spo2,
    log.excretion.map(e => `${e.time}:${e.urine}`).join('\n'),
    log.excretion.map(e => `${e.time}:${e.stool}`).join('\n'),
    log.hydration.map(h => `${h.time}:${h.type}:${h.amount}`).join('\n'),
    `${log.meal.breakfast}\n${log.meal.lunch}\n${log.meal.dinner}`,
    log.bath,
    log.tasks.body,
    log.notes,
    log.signature,
  ]);

  // グラフ用データ（Excel下部に出力・グラフ自動生成用）
  const graphHeader = [
    '日付', '氏名', '水分摂取量合計', '排尿回数', '排便回数', '平均体温', '平均脈拍', '平均SpO2', '最高血圧', '最低血圧', '朝食', '昼食', '夕食'
  ];
  const graphRows = logs.map(log => [
    log.date,
    log.userName,
    log.hydration.reduce((sum, h) => sum + Number(h.amount), 0),
    log.excretion.filter(e => e.urine).length,
    log.excretion.filter(e => e.stool).length,
    log.vitals.temp,
    log.vitals.pulse,
    log.vitals.spo2,
    log.vitals.bpSystolic,
    log.vitals.bpDiastolic,
    log.meal.breakfast,
    log.meal.lunch,
    log.meal.dinner,
  ]);

  // Excelシート下部に集計データを出力（グラフ自動生成用）
  return [...header, ...rows, [], graphHeader, ...graphRows];
}

// グラフ用データ設計例（Excelで自動生成推奨）
// 1. 水分摂取量推移（日付×利用者ごと）: graphRowsの「水分摂取量合計」列
// 2. バイタル推移（体温・血圧・脈拍・SpO2）: graphRowsの該当列
// 3. 排尿・排便回数: graphRowsの「排尿回数」「排便回数」列
// 4. 食事摂取量: graphRowsの「朝食」「昼食」「夕食」列
// Excelのグラフ機能で範囲選択→折れ線/棒グラフ等を自動生成可能

=== CONTENT END ===
***/
